Status: draft
Title: PhonGap ネットワークの接続判定
Date: 2014-05-19 18:00
Category: phonegap
Tags: phonegap, network
Slug: phonegapnetworkcheck
Author: youske
Summary: PhoneGapでのネットワーク判定

# はじめに
ネットワークに接続しないアプリケーションであれば必要は無いが、ネットワークが接続しているか、否か判定したい時がある。
そこでネットワーク判定を実施できるようにしてみる。

# このような設定
ドキュメントを見る限りでは次のようなことでいいようだ

  onDeviceReady: {
    addEventListener('online');  
  }
  
  onOnline;{
  
  }
  onOffline {
  
  }

# 問題点
phongap下で実行して見たところdevicereadyが来る前にonline,offlineイベントは早く到着するようなので
devicereadyを待って実行されるようなものでは当然反映されない。
あとdevicereadyを待ってからaddEventlistnerをしてみたところ、そもそも判定は終わっており、online,offlineの状態は検出タイミングがずれる。


# 解決方法
参考:
http://css.dzone.com/articles/cordova-formerly-phonegap-1


起動時にはブラウザからのネットワークステータスを見て動作を行い。
online,offlineはアプリが動作中の判定で用いる。

devicereadyでの登録

if (navigator.network.connection.type != Connection.NONE) {
03.
NetworkType();
04.
}
05.
else {
06.
alert("You are not connected");
07.
}
08.
document.addEventListener("online", onOnline, false);
09.
document.addEventListener("offline", onOffline, false);

function NetworkType() {
02.
switch (navigator.network.connection.type) {
03.
case Connection.UNKNOWN:
04.
alert("Connection type is not known");
05.
break;
06.
case Connection.ETHERNET:
07.
alert("Connection type is Ethernet");
08.
break;
09.
case Connection.WIFI:
10.
alert("Connection type is WiFi");
11.
break;
12.
case Connection.CELL_2G:
13.
alert("Connection type is 2G");
14.
break;
15.
case Connection.CELL_3G:
16.
alert("Connection type is 3G");
17.
break;
18.
case Connection.CELL_4G:
19.
alert("Connection type is 4G");
20.
break;
21.
case Connection.NONE:
22.
alert('No Network Connection');
23.
break;
24.
}
25.
}



フロー
devicereadyが到着したら
navigatorを確認して、初期状態とする。
online, offlineイベントを登録して
アプリが動作中にネットワークのステータスが変わったらイベントキャッチして、アプリ側から適切な対処を入れる。

# さらに
どうやらdeviceready直後はnavigator.networkを取得できないようだ。
そこでトップレベルから取得する。

     if( !navigator.network )
     {
         // set the parent windows navigator network object to the child window
         navigator.network = window.top.navigator.network;
     }

