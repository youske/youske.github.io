Status: draft
Title: communicationライブラリ
Date: 2014-05-25 18:20
Category: tips
Tags: firebase, library, fbchat
Slug: fbchatabout
Author: youske
Summary: firebaseを利用したコミュニケーションライブラリ

# 概要
firabaseを利用したコミュニケーション用ライブラリ javascript版

* ユーザを識別するためにUsersを利用する。
* ユーザ認証はfirebase側の認証を用いる。
* やりとりされるメッセージはすべてevent_xxxxに格納される。
* ユーザは任意のタイミングでevent_xxxxデータを読み込む事ができる。
* ユーザの起こした行動はevent_xxxxに格納される。
* ユーザの諸情報はUsersに格納される。
* 定期的にスナップショットをsnapshot_xxxxに格納される。
* 全体で共有される情報あはsystem_xxxxに格納される。
* 部屋の概念がありroomとする。
* roomには最大収容人数が設定されており（デフォルト４名 最大8名）
* roomに侵入した場合直近のスナップショットから復元される。


event_<xxxxx
データを分割するため一定の間隔でデータが１０分間隔データの格納位置が変わる。

## データ構造

    root
      |
      + system システム全体での共有データ管理
      |
      + event_


### system
system.robby_counter
system.room_counter

### global
global.send()
global.counter
global.event

### robby
robby.create_room
robby.delete_room
robby.rename
robby.setpasswd


### roomデータ構造
room.name
room.intervals
room.event_counter
room.snapshot_counter
room.events_xxxx
room.snapshot_xxxx
room.enter
room.leave
room.send イベントの発行


## コマンド
発言としてメッセージを送る。
相手を指定してメッセージを送る
エモーションを送る。
空間の位置を変える。
部屋から出る。
部屋に入る。
部屋のリストを取る。
直近のスナップショットを取る。
ユーザのプロフィールを見る。
ロビーに入る
ロビーから出る。



### room.event_xxxxについて
room.event_xxxxは10分間のデータを表現する。
システム側でデータが１０分を超えるばあい新たにテーブルを作り、そこに格納される。
これはデータが不必要にデータが大きくなること、それを横断することを避けるためにデータのパーティショニングを行う。
システム上、サーバが不在の為、クライアントライブラリ側で実装することを期待する。


### room.snapshot_eventについて
スナップショットは２分間程度で定期的に現在のルーム参加者の現在の行動に関して完全なスナップショットを取る。
主にはユーザの位置、見た目、発言内容などを保存する。

スナップショットデータはクライアント側で取得され、データを一致させる。
スナップショットの切り替わりでイベントが発生しても、其のタイミングからのスナップショットであるため同期は失われない。





